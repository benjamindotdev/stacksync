<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StackSync Playground</title>
    <style>
        :root {
            --bg: #f4f4f5;
            --text: #18181b;
            --card-bg: #ffffff;
            --border: #e4e4e7;
            --input-bg: #ffffff;
        }
        [data-theme="dark"] {
            --bg: #18181b;
            --text: #f4f4f5;
            --card-bg: #27272a;
            --border: #3f3f46;
            --input-bg: #27272a;
        }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        h1 { margin-bottom: 1rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .container { display: grid; gap: 2rem; }
        .input-section { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap; }
        select, input[type="color"] { padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); }
        textarea { width: 100%; height: 200px; font-family: monospace; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 1rem; background: var(--input-bg); color: var(--text); }
        button { background: #2563eb; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; }
        button:hover { background: #1d4ed8; }
        button.secondary { background: var(--border); color: var(--text); }
        button.secondary:hover { opacity: 0.9; }
        .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .tech-item { background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 0.5rem; border: 1px solid var(--border); }
        .tech-item img { width: 48px; height: 48px; object-fit: contain; }
        .tech-name { font-size: 0.875rem; font-weight: 500; }
        .error { color: #dc2626; margin-top: 0.5rem; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>StackSync Playground</h1>
                <p>Paste a package.json content below to see detected technologies.</p>
            </div>
            <button class="secondary" onclick="toggleTheme()">Toggle Theme</button>
        </div>

        <div class="input-section">
            <div class="controls">
                <label>
                    Color Mode:
                    <select id="colorMode" onchange="scan()">
                        <option value="default">Default (Brand)</option>
                        <option value="white">White</option>
                        <option value="black">Black</option>
                        <option value="custom">Custom</option>
                    </select>
                </label>
                <label id="customColorContainer" style="display: none;">
                    Custom Color:
                    <input type="color" id="customColor" value="#FF5733" onchange="scan()">
                </label>
            </div>

            <textarea id="input" placeholder='{
  "dependencies": {
    "react": "^18.0.0",
    "typescript": "^5.0.0",
    "next": "^13.0.0",
    "tailwindcss": "^3.0.0"
  }
}'>{
  "dependencies": {
    "react": "^18.0.0",
    "typescript": "^5.0.0",
    "next": "^13.0.0",
    "tailwindcss": "^3.0.0"
  }
}</textarea>
            <button onclick="scan()">Scan Dependencies</button>
            <div id="error" class="error"></div>
        </div>

        <div id="results" class="results"></div>

        <div class="input-section" style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 2rem;">
            <h2>Batch Import</h2>
            <p style="margin-bottom: 1rem; color: var(--text); opacity: 0.8;">
                Place your project folders in <code>playground-app/stacksync/input/</code> and click below.
            </p>
            
            <div class="controls">
                <label>
                    Color Mode:
                    <select id="batchColorMode">
                        <option value="brand">Brand (Default)</option>
                        <option value="white">White</option>
                        <option value="black">Black</option>
                        <option value="custom">Custom</option>
                    </select>
                </label>
                <label id="batchCustomColorContainer" style="display: none;">
                    Custom Color:
                    <input type="color" id="batchCustomColor" value="#FF5733">
                </label>
            </div>

            <button onclick="runBatchImport()">Run Batch Import</button>
            <div id="batch-results" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        document.getElementById('batchColorMode').addEventListener('change', (e) => {
            const customContainer = document.getElementById('batchCustomColorContainer');
            customContainer.style.display = e.target.value === 'custom' ? 'inline-flex' : 'none';
        });

        async function runBatchImport() {
            const btn = document.querySelector('button[onclick="runBatchImport()"]');
            const resultsDiv = document.getElementById('batch-results');
            const colorMode = document.getElementById('batchColorMode').value;
            let color = colorMode;
            
            if (colorMode === 'custom') {
                color = document.getElementById('batchCustomColor').value;
            }
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            resultsDiv.innerHTML = '';

            try {
                const res = await fetch('/api/batch-import', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ color })
                });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                if (data.length === 0) {
                    resultsDiv.innerHTML = '<p>No projects found or processed.</p>';
                } else {
                    data.forEach(project => {
                        const projectDiv = document.createElement('div');
                        projectDiv.style.background = 'var(--card-bg)';
                        projectDiv.style.border = '1px solid var(--border)';
                        projectDiv.style.borderRadius = '8px';
                        projectDiv.style.padding = '1rem';
                        projectDiv.style.marginBottom = '1rem';
                        
                        const title = document.createElement('h3');
                        title.textContent = project.name;
                        title.style.marginTop = '0';
                        projectDiv.appendChild(title);

                        const stackContainer = document.createElement('div');
                        stackContainer.className = 'results';
                        stackContainer.style.marginTop = '1rem';

                        project.stack.forEach(tech => {
                            const techItem = document.createElement('div');
                            techItem.className = 'tech-item';

                            const img = document.createElement('img');
                            
                            // Use the color from the stack.json if available (which comes from batch import logic)
                            // But we also want to support the visual preview in the playground if the user changes theme locally?
                            // The user asked for "option to select different colour modes there" which implies the batch import *process* uses it.
                            // So the stack.json will have the correct color.
                            // However, the playground also has a "local" coloring feature for the top scanner.
                            // For batch import, we rely on the generated stack.json color or the logo URL.
                            // Since we just ran batch import with the color, the stack.json should have the correct color field.
                            // But the logo URL is still pointing to raw github.
                            // If we want to visualize it here, we can use the same local proxy trick if we want instant feedback,
                            // OR we trust that the batch import logic set the 'color' field and we use that.
                            // But wait, the image src is remote. We can't color a remote SVG with CSS unless we inline it or use a proxy.
                            // The playground proxy `/assets/...` handles coloring.
                            // Let's use the proxy to visualize the result of the batch import selection.
                            
                            const relativePath = tech.logo.split('assets/logos/')[1];
                            if (relativePath) {
                                // We use the color that was selected for the batch import
                                // We can pass it as a query param to the local asset proxy
                                let proxyColorMode = colorMode;
                                let proxyCustomColor = '';
                                
                                if (colorMode === 'custom') {
                                    proxyCustomColor = encodeURIComponent(color);
                                } else if (colorMode === 'brand') {
                                    proxyColorMode = 'default';
                                }
                                
                                img.src = `/assets/${relativePath}?colorMode=${proxyColorMode}&customColor=${proxyCustomColor}`;
                            } else {
                                img.src = tech.logo;
                            }
                            
                            img.alt = tech.name;
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'tech-name';
                            nameSpan.textContent = tech.name;
                            
                            // Optional: Show the hex code if debugging
                            // const colorSpan = document.createElement('span');
                            // colorSpan.style.fontSize = '10px';
                            // colorSpan.textContent = tech.color;
                            // techItem.appendChild(colorSpan);

                            techItem.appendChild(img);
                            techItem.appendChild(nameSpan);
                            stackContainer.appendChild(techItem);
                        });

                        projectDiv.appendChild(stackContainer);
                        resultsDiv.appendChild(projectDiv);
                    });
                }

            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Batch Import';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
        }

        document.getElementById('colorMode').addEventListener('change', (e) => {
            const customContainer = document.getElementById('customColorContainer');
            customContainer.style.display = e.target.value === 'custom' ? 'inline-flex' : 'none';
        });

        async function scan() {
            const input = document.getElementById('input').value;
            const errorEl = document.getElementById('error');
            const resultsEl = document.getElementById('results');
            const colorMode = document.getElementById('colorMode').value;
            const customColor = document.getElementById('customColor').value;
            
            errorEl.style.display = 'none';
            resultsEl.innerHTML = '';

            try {
                // Validate JSON first
                JSON.parse(input);

                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: input
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.length === 0) {
                    resultsEl.innerHTML = '<p style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No matching technologies found.</p>';
                    return;
                }

                data.forEach(tech => {
                    const div = document.createElement('div');
                    div.className = 'tech-item';
                    
                    // Construct URL with color params
                    const url = new URL(tech.logoUrl, window.location.origin);
                    url.searchParams.set('colorMode', colorMode);
                    if (colorMode === 'custom') {
                        url.searchParams.set('customColor', customColor);
                    }

                    div.innerHTML = `
                        <img src="${url.toString()}" alt="${tech.name}" onerror="this.style.display='none'">
                        <span class="tech-name">${tech.name}</span>
                    `;
                    resultsEl.appendChild(div);
                });

            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
            }
        }

        // Initial scan
        scan();
    </script>
</body>
</html>
